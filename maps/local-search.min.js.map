{"version":3,"sources":["local-search.js"],"names":["searchEscape","keyword","htmlEntityMap","&","<",">","\"","'","/","replace","i","regEscape","regEntityMap","{","}","[","]","(",")","?","*",".","+","^","$","getParam","reqParam","results","RegExp","exec","window","location","decodeURIComponent","setNotice","type","info","searchInfo","document","getElementById","className","innerText","clearPosts","innerHTML","createPosts","resArr","resultSectionElement","resultString","forEach","resInfo","pageInfo","pageTags","tags","tag","postTagTemplate","postTemplate","category","link","title","content","date","loadDataSearch","searchDataFile","skeys","fetch","then","res","NProgress","inc","json","datas","startTime","performance","now","resultArray","resultCount","keywords","trim","toLowerCase","split","data","matched","dataTitle","dataContent","dataWeight","indexs","firstOccur","lastOccur","halfLenth","indexOf","tPage","Date","toLocaleDateString","categories","url","regS","start","end","length","substr","push","finishTime","Math","round","sort","a","b","done","catch","error","keySearch","inpSearch","value","history","pushState","href"],"mappings":"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","file":"../js/local-search.min.js","sourcesContent":["function searchEscape(keyword) {\n    const htmlEntityMap = {\n        '&': '&amp;',\n        '<': '&lt;',\n        '>': '&gt;',\n        '\"': '&quot;',\n        '\\'': '&#39;',\n        '/': '&#x2F;'\n    };\n\n    return keyword.replace(/[&<>\"'/]/g, function (i) {\n        return htmlEntityMap[i];\n    });\n}\n\nfunction regEscape(keyword) {\n    const regEntityMap = {\n        '{': '\\\\\\{',\n        '}': '\\\\\\}',\n        '[': '\\\\\\[',\n        ']': '\\\\\\]',\n        '(': '\\\\\\(',\n        ')': '\\\\\\)',\n        '?': '\\\\\\?',\n        '*': '\\\\\\*',\n        '.': '\\\\\\.',\n        '+': '\\\\\\+',\n        '^': '\\\\\\^',\n        '$': '\\\\\\$'\n    };\n\n    return keyword.replace(/[\\{\\}\\[\\]\\(\\)\\?\\*\\.\\+\\^\\$]/g, function (i) {\n        return regEntityMap[i];\n    });\n}\n\nfunction getParam(reqParam) {\n    // 获取参数\n    reqParam = reqParam.replace(/[\\[]/, \"\\\\\\[\").replace(/[\\]]/, \"\\\\\\]\");\n    const paraReg = new RegExp('[\\\\?&]' + reqParam + '=([^&#]*)');\n    const results = paraReg.exec(window.location);\n    return results === null ? '' : decodeURIComponent(results[1].replace(/\\+/g, ' '));\n}\n\nfunction setNotice(type, info) {\n    const searchInfo = document.getElementById('kr-search-notice');\n    searchInfo.className = 'alert alert-' + type;\n    searchInfo.innerText = info;\n}\n\nfunction clearPosts() {\n    const resultSectionElement = document.getElementById('result-posts');\n    resultSectionElement.innerHTML = '';\n}\n\nfunction createPosts(resArr) {\n    const resultSectionElement = document.getElementById('result-posts');\n    let resultString = '';\n\n    resArr.forEach((resInfo)=>{\n        const pageInfo = resInfo[0];\n        let pageTags = '';\n        pageInfo.tags.forEach((tag, i)=>{\n            pageTags += i ? ', ' : '';\n            const postTagTemplate = `<a class=\"tag-link\" href=\"${tag[1]}\" rel=\"tag\">${tag[0]}</a>`;\n            pageTags += postTagTemplate;\n        });\n        const postTemplate = `\n        <article class=\"kratos-hentry clearfix\">\n            <div class=\"kratos-entry-border-new clearfix\">\n                <div class=\"kratos-post-inner-new kr-search-result\">\n                    <header class=\"kratos-entry-header-new\">\n                        ${ pageInfo.category[0]!=='undefined' ? `<a class=\"label-link\" href=\"${pageInfo.category[1]}\">${pageInfo.category[0]}</a>` : '' }\n                        <h2 class=\"kratos-entry-title-new\"><a href=\"${pageInfo.link}\">${pageInfo.title}</a></h2>\n                    </header>\n                    <div class=\"kratos-entry-content-new\">\n                        <p>...${pageInfo.content}...</p>\n                    </div>\n                </div>\n                <div class=\"kratos-post-meta-new\">\n                    <span class=\"pull-left\">\n                        <a><i class=\"fa fa-calendar\"></i></a><a>${pageInfo.date}</a>\n                        <a><i class=\"fa fa-tags\"></i></a>\n                        ${pageTags}\n                    </span>\n                </div>\n            </div>\n        </article>\n        `;\n\n        resultString += postTemplate;\n    });\n    resultSectionElement.innerHTML = resultString;\n}\n\nfunction loadDataSearch(searchDataFile, skeys) {\n    fetch(searchDataFile)\n        .then((res)=>{\n            setNotice('success', '文件加载完成，开始搜索啦~');\n            if (typeof NProgress !== 'undefined') {\n                NProgress.inc();\n            }\n            return res.json();\n        })\n        .then((datas)=>{\n            const startTime = performance.now();\n            let resultArray = [];\n            let resultCount = 0;\n            let keywords = skeys.trim().toLowerCase().split(/\\s/);\n\n            datas.forEach((data)=>{\n                if (typeof data.title === 'undefined' || typeof data.content === 'undefined') {\n                    return;\n                }\n\n                // 开始匹配\n                let matched = false;\n\n                const dataTitle      = data.title.trim().toLowerCase();\n                const dataContent    = data.content ? data.content.trim().replace(/<[^>]+>/g, '').toLowerCase() : '';\n                let   dataWeight     = 0;\n\n                let indexs = {};\n                indexs.title        = -1;\n                indexs.content      = -1;\n                indexs.firstOccur   = -1;\n                indexs.lastOccur    = -1;\n                const halfLenth = 100;\n\n                if (dataTitle) {\n                    keywords.forEach((keyword)=>{\n                        indexs.title = dataTitle.indexOf(keyword);\n                        indexs.content = dataContent.indexOf(keyword);\n                        if (indexs.title !== -1 || indexs.content !== -1) {\n                            matched = true;\n                            if (indexs.content !== -1) {\n                                if (indexs.firstOccur > indexs.content || indexs.firstOccur === -1) {\n                                    indexs.firstOccur = indexs.content;\n                                }\n                                if (indexs.lastOccur < indexs.content) {\n                                    indexs.lastOccur = indexs.content;\n                                }\n                            } else {\n                                //命中 title，但正文 conten 未命中时\n                                indexs.firstOccur = halfLenth;\n                                indexs.lastOccur = 0;\n                            }\n                            dataWeight += indexs.title   !== -1 ? 2 : 0;\n                            dataWeight += indexs.content !== -1 ? 1 : 0;\n                            resultCount++;\n                        }\n                    });\n                }\n\n                // 设置高亮\n                if (matched) {\n                    let tPage = {};\n                    tPage.title = data.title;\n                    tPage.date = new Date(data.date).toLocaleDateString();\n                    tPage.tags = data.tags || [];\n                    tPage.category = data.categories[0] || [];\n                    tPage.link = data.url;\n                    keywords.forEach((keyword)=>{\n                        const regS = new RegExp(regEscape(keyword) + '(?!>)', 'gi');\n                        tPage.title = tPage.title.replace(regS, '<m>$&</m>');\n                    });\n                    if (indexs.firstOccur >= 0) {\n                        //const halfLenth = 100;\n                        let start = indexs.firstOccur - halfLenth;\n                        let end   = indexs.lastOccur + halfLenth;\n                        if (start < 0) {\n                            start = 0;\n                        }\n                        if (start === 0) {\n                            end = halfLenth * 2;\n                        }\n                        if (end > dataContent.length) {\n                            end = dataContent.length;\n                        }\n                        tPage.content = dataContent.substr(start, end-start);\n                        keywords.forEach((keyword)=>{\n                            const regS = new RegExp(regEscape(keyword) + '(?!>)', 'gi');\n                            tPage.content = tPage.content.replace(regS, '<m>$&</m>');\n                        });\n                    }\n                    resultArray.push([tPage, dataWeight]);\n                }\n\n            });\n            if (resultCount !== 0) {\n                const finishTime = performance.now();\n                setNotice('success', '找到 ' + resultCount + ' 条搜索结果，用时 ' + Math.round((finishTime - startTime)*100)/100 + ' 毫秒~');\n                resultArray.sort((a, b)=>{\n                    return b[1] - a[1];\n                });\n                createPosts(resultArray);\n            } else {\n                setNotice('danger', '什么都没有找到欸...');\n                clearPosts();\n            }\n            if (typeof NProgress !== 'undefined') {\n                NProgress.done();\n            }\n        })\n        .catch((error)=>{\n            setNotice('danger', '错误 : ' + error);\n        });\n}\n\nfunction keySearch(skeys) {\n    // 设置搜索提示\n    setNotice('info', '正在加载搜索文件...');\n\n    // 启动进度条\n    if (typeof NProgress !== 'undefined') {\n        NProgress.start();\n    }\n\n    // 加载数据并搜索\n    loadDataSearch(searchDataFile, searchEscape(skeys));\n}\n\nfunction inpSearch() {\n    // 单击按钮检索\n    const skeys = document.getElementById('search-input').value;\n    // 更新URL\n    window.history.pushState({},0,window.location.href.split('?')[0]+'?s=' + skeys.replace(/\\s/g, '+'));\n    // 开始搜索\n    keySearch(skeys);\n    return false;\n}\n\n(()=>{\n    const skeys = getParam('s');\n    if (skeys !== '') {\n        // 存在关键词，把搜索词放到输入框里面\n        document.getElementById('search-input').value = skeys;\n        // 开始搜索\n        keySearch(skeys);\n    }\n})();"]}